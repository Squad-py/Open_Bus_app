{% extends "layout.html" %}

{% block content %}
<style>/* From Uiverse.io by vinodjangid07 */ 
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif
}

.container {
    margin: 30px auto;
}

.container .card {
    width: 100%;
    box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
    background: #fff;
    border-radius: 0px;
}





.btn.btn-primary {
    background-color: #ddd;
    color: black;
    box-shadow: none;
    border: none;
    font-size: 20px;
    width: 100%;
    height: 100%;
}

.btn.btn-primary:focus {
    box-shadow: none;
}

.container .card .img-box {
    width: 80px;
    height: 50px;
}

.container .card img {
    width: 100%;
    object-fit: fill;
}

.container .card .number {
    font-size: 24px;
}

.container .card-body .btn.btn-primary .fab.fa-cc-paypal {
    font-size: 32px;
    color: #3333f7;
}

.fab.fa-cc-amex {
    color: #1c6acf;
    font-size: 32px;
}

.fab.fa-cc-mastercard {
    font-size: 32px;
    color: red;
}

.fab.fa-cc-discover {
    font-size: 32px;
    color: orange;
}

.c-green {
    color: green;
}

.box {
    height: 40px;
    width: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #ddd;
}

.btn.btn-primary.payment {
    background-color: #1c6acf;
    color: white;
    border-radius: 0px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 24px;
}


.form__div {
    height: 50px;
    position: relative;
    margin-bottom: 24px;
}

.form-control {
    width: 100%;
    height: 45px;
    font-size: 14px;
    border: 1px solid #DADCE0;
    border-radius: 0;
    outline: none;
    padding: 2px;
    background: none;
    z-index: 1;
    box-shadow: none;
}

.form__label {
    position: absolute;
    left: 16px;
    top: 10px;
    background-color: #fff;
    color: #80868B;
    font-size: 16px;
    transition: .3s;
    text-transform: uppercase;
}

.form-control:focus+.form__label {
    top: -8px;
    left: 12px;
    color: #1A73E8;
    font-size: 12px;
    font-weight: 500;
    z-index: 10;
}

.form-control:not(:placeholder-shown).form-control:not(:focus)+.form__label {
    top: -8px;
    left: 12px;
    font-size: 12px;
    font-weight: 500;
    z-index: 10;
}

.form-control:focus {
    border: 1.5px solid #1A73E8;
    box-shadow: none;
}

</style>
<head>    <script src="https://js.stripe.com/v3/"></script>
</head>
<div class="container">
    <h1>Recarga de Saldo</h1>
    
    <!-- Sección de Saldo Actual dentro de un círculo azul -->
    <div class="saldo-actual" style="text-align: center; margin-bottom: 20px;">
        <div style="background-color: #007bff; color: white; width: 250px; height: 250px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
            <h3 id="saldo">MXN {{ card.balance }} SALDO ACTUAL</h3>
        </div>
    </div>

  <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepción ILP - Open Payments</title>
    <style>
        /* Variables de colores y estilos */
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --background: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --border-focus: #93c5fd;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 8px;
            --transition: all 0.3s ease;
        }





        /* Tarjeta de contenido */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        /* Encabezados */
        h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-weight: 600;
            text-align: center;
        }

        /* Grupos de formulario */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
        }

        /* Botones */
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        /* Estados de mensajes */
        .error {
            color: var(--error);
            background-color: rgba(239, 68, 68, 0.1);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            border-left: 4px solid var(--error);
            margin: 1rem 0;
        }

        .success {
            color: var(--success);
            background-color: rgba(16, 185, 129, 0.1);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            border-left: 4px solid var(--success);
            margin: 1rem 0;
        }

        /* Iframe */
        iframe {
            width: 100%;
            height: 400px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-top: 1rem;
            box-shadow: var(--shadow);
        }

        /* Responsividad */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            input[type="text"],
            input[type="number"],
            button {
                padding: 0.625rem 0.875rem;
            }
        }

        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* Loader para el botón */
        .button-loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Cabecera y pie */
        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        header img {
            height: 60px;
            margin-bottom: 1rem;
        }

        footer {
            text-align: center;
            margin-top: 2rem;
            color: var(--text-light);
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Open Payments</h1>
        </header>
        
        <div class="card fade-in">
            <h2>Recepción ILP</h2>
            
<div class="form-group">
  <label for="gg">Wallet destinatario:</label>
  <input type="text" id="gg" value="https://ilp.interledger-test.dev/cmov" disabled>
</div>

<div class="form-group">
  <label for="destinatario">Tu Wallet:</label>
  <input type="text" id="destinatario" value="" >
</div>
            
            <div class="form-group">
                <label for="monto">Monto:</label>
                <input type="number" id="monto" placeholder="0.00" step="0.01">
            </div>
            
            <div class="form-group">
                <label for="descripcion">Descripción:</label>
                <input type="text" id="descripcion" placeholder="Descripción del pago" value="RECARGA DE TARJETA DE PREPAGO" disabled>
            </div>
            
            <button id="startPayment">
                <span>Iniciar Recepción</span>
            </button>
            
            <div id="links"></div>
        </div>
        
        <iframe id="iframePayment" style="display:none;"></iframe>
        

        <!-- Mapa de puntos de recarga con Leaflet -->
<div class="mapa-recarga" style="margin-top: 30px;">
  <h3>Puntos de Recarga Cercanos</h3>
  <div id="map" style="height: 400px;"></div>
</div>
        <footer>
            <p>Sistema seguro de pagos ILP • Open Payments</p>
        </footer>
    </div>

    <script>
        let incomingPaymentId = null;
        let incomingUrl = "";

        // Iniciar recepción de pago
        document.getElementById("startPayment").addEventListener("click", async () => {
            const destinatario = document.getElementById("destinatario").value;
            const monto = document.getElementById("monto").value;
            const descripcion = document.getElementById("descripcion").value;
            const button = document.getElementById("startPayment");

            if (!destinatario || !monto || !descripcion) {
                alert("Por favor completa todos los campos");
                return;
            }

            // Mostrar estado de carga en el botón
            button.innerHTML = '<div class="button-loader"></div> Procesando...';
            button.disabled = true;

            try {
                const res = await fetch("https://58bc2g95-3000.usw3.devtunnels.ms/start-payment", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ destinatario, monto, description: descripcion })
                });

                const data = await res.json();

                if (res.ok) {
                    incomingPaymentId = data.incomingPaymentId;
                    incomingUrl = data.url;  // Link para recibir pago

                    document.getElementById("links").innerHTML = `
                        <p class="success">✅ Pago listo! Se abrirá automáticamente en el iframe.</p>
                    `;

                    const iframe = document.getElementById("iframePayment");
                    iframe.src = incomingUrl;
                    iframe.style.display = "block";

                    // Polling al backend para continuar automáticamente
                    const checkPayment = setInterval(async () => {
                        try {
                            const res = await fetch("https://58bc2g95-3000.usw3.devtunnels.ms/continue-payment", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ incomingPaymentId })
                            }); 
                            const result = await res.json();

                            // Si el pago ya está aceptado, termina el polling y muestra éxito
                            if (res.ok && result.status == "Accepted") {
                                clearInterval(checkPayment);
                                document.getElementById("links").innerHTML = `<p class="success">✅ Pago completado automáticamente!</p>`;
                                document.getElementById("iframePayment").style.display = "none";
                                console.log("Pago recibido exitosamente:", result);
                            }
                        } catch (e) {
                            console.error("Error verificando pago:", e);
                        }
                    }, 2000);

                } else {
                    document.getElementById("links").innerHTML = `<p class="error">❌ Error: ${data.error}</p>`;
                    console.error(data.error);
                }

            } catch (err) {
                document.getElementById("links").innerHTML = `<p class="error">❌ Error de conexión: ${err}</p>`;
                console.error(err);
            } finally {
                // Restaurar el botón a su estado original
                button.innerHTML = '<span>Iniciar Recepción</span>';
                button.disabled = false;
            }
        });
    </script>
</body>
</html>
  
<!-- Carga de Leaflet CSS y JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

  let puntosRecarga = []; // Inicializar variable

  // Cargar los puntos desde el backend de Flask
  fetch('/api/puntos_recarga')
      .then(response => response.json())
      .then(data => {
          puntosRecarga = data; // Guardar los puntos de recarga en la variable
          console.log("Puntos de recarga cargados:", puntosRecarga);
          obtenerUbicacionYMostrarPuntos(); // Llamar función para obtener ubicación y mostrar puntos
      })
      .catch(error => console.error('Error al cargar los puntos:', error));

  // Función para calcular la distancia entre dos puntos usando la fórmula de Haversine (opcional si lo necesitas)
  function calcularDistancia(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radio de la Tierra en km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // Distancia en km
  }

   // Función para obtener la ubicación actual del usuario y mostrar los puntos alternadamente
   function obtenerUbicacionYMostrarPuntos() {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
              const latitudUsuario = position.coords.latitude;
              const longitudUsuario = position.coords.longitude;
              
              // Crear mapa centrado en la ubicación del usuario
              const map = L.map('map').setView([latitudUsuario, longitudUsuario], 13);

              // Agregar el mapa base de OpenStreetMap
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
              }).addTo(map);

              // Añadir un marcador para la ubicación del usuario
              L.marker([latitudUsuario, longitudUsuario]).addTo(map)
                  .bindPopup("<b>Tu ubicación actual</b>")
                  .openPopup();

              // Mostrar solo los puntos alternados (uno sí, uno no)
              puntosRecarga.forEach((punto, index) => {
                  if (index % 2 === 0) {  // Solo muestra los puntos con índices pares
                      const customIcon = L.icon({
                          iconUrl: "{{ url_for('static', filename='soluciones.png') }}", // URL de tu imagen
                          iconSize: [32, 32], // Tamaño de la imagen
                          iconAnchor: [16, 32], // El punto de anclaje del icono
                          popupAnchor: [0, -32] // Donde se muestra el popup
                      });

                      // Crear un marcador con la imagen personalizada
                      L.marker([punto.latitud, punto.longitud], { icon: customIcon })
                          .addTo(map)
                          .bindPopup(`<b>Punto de Recarga</b><br>${punto.direccion}`);
                  }
              });

          }, function() {
              alert("No se pudo obtener la ubicación.");
          });
      } else {
          alert("La geolocalización no está soportada por este navegador.");
      }
  }
</script>

{% endblock %}
